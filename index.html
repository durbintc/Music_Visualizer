<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Make Textures - Spotify Edition</title>

    <script id="vertex-shader" type="x-shader/x-vertex">#version 300 es

      in vec4 vPosition;
      in vec2 texCoord;

      out vec2 ftexCoord;

      uniform mat4 model_view;
      uniform mat4 projection;
      void main()
      {	

        ftexCoord = texCoord;

        gl_Position = projection * model_view*vPosition;
        

      }

    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">#version 300 es
      precision mediump float;

      in vec2 ftexCoord;
      uniform sampler2D textureSampler;

      out vec4  fColor;

      void main()
      {
        fColor = texture(textureSampler, ftexCoord);
      }

    </script>

    <script type="module" src="./src/maketexturefunctions.ts"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: #ffffff;
            padding: 20px;
        }
        
        .controls {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        button {
            background: #1db954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
        }
        
        button:hover {
            background: #1ed760;
        }
        
        button#spotify-login {
            background: #191414;
        }
        
        button#spotify-login:hover {
            background: #282828;
        }
        
        #status {
            margin-top: 10px;
            padding: 10px;
            background: #282828;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="controls">
    <h1>üéµ Music Visualizer with Spotify</h1>
    <div style="margin-bottom: 15px;">
        <button id="spotify-login">üéß Login with Spotify</button>
        <button id="retry-audio" style="background: #ff6b00;">üîÑ Retry Audio Connection</button>
    </div>
    <div style="margin-bottom: 15px;">
        <label for="playlist-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Playlist URL or ID (optional):</label>
        <input 
            type="text" 
            id="playlist-input" 
            placeholder="Leave empty to resume current playback, or paste playlist URL/ID"
            style="width: 500px; padding: 8px; border: 2px solid #1db954; border-radius: 4px; background: #282828; color: white; font-size: 14px;"
            value=""
        />
        <button id="start">‚ñ∂Ô∏è Play</button>
        <button id="pause" style="background: #ff0000;">‚è∏Ô∏è Pause</button>
    </div>
    <div style="margin-bottom: 15px;">
        <button id="previous" style="background: #535353;">‚èÆÔ∏è Previous</button>
        <button id="next" style="background: #535353;">‚è≠Ô∏è Next</button>
        <button id="shuffle" style="background: #1db954;">üîÄ Shuffle</button>
    </div>
    <div id="status">Status: Ready. Login with Spotify or use microphone/MP3.</div>
</div>

<audio id="music" src="../ponyboy.mp3" crossorigin="anonymous" style="display: none;"></audio>
<canvas id="gl-canvas" width="1500" height="512">
    Sorry; your web browser doesn't support HTML5's canvas element.
</canvas>

<div class="controls">
    <h2>‚å®Ô∏è Controls</h2>
    <ul>
        <li><strong>1</strong> = toggle bass frequencies</li>
        <li><strong>2</strong> = toggle mid frequencies</li>
        <li><strong>3</strong> = toggle high frequencies</li>
        <li><strong>‚Üë</strong> = zoom in</li>
        <li><strong>‚Üì</strong> = zoom out</li>
        <li><strong>C</strong> = toggle color mode</li>
        <li><strong>R/G/B</strong> = increase red/green/blue</li>
        <li><strong>T/H/N</strong> = decrease red/green/blue</li>
        <li><strong>Mouse drag</strong> = rotate view</li>
    </ul>
</div>

<div class="controls">
    <h2>üéÆ How to Use</h2>
    <ol>
        <li><strong>Login with Spotify</strong> ‚Üí Authorize the app (requires Premium)</li>
        <li><strong>Choose playback mode:</strong>
            <ul>
                <li><strong>Option A - Resume Current Playback:</strong>
                    <ul>
                        <li>Play something in your Spotify app (phone, desktop, web)</li>
                        <li>Leave the playlist field <strong>empty</strong></li>
                        <li>Click "‚ñ∂Ô∏è Play" to visualize what's currently playing</li>
                    </ul>
                </li>
                <li><strong>Option B - Start New Playlist:</strong>
                    <ul>
                        <li>Go to Spotify ‚Üí Find any playlist ‚Üí Right-click ‚Üí Share ‚Üí Copy link</li>
                        <li>Paste the link in the input box</li>
                        <li>Click "‚ñ∂Ô∏è Play" to start that playlist</li>
                    </ul>
                </li>
            </ul>
        </li>
        <li><strong>Grant microphone access</strong> when prompted (to capture audio for visualization)</li>
        <li><strong>Enjoy!</strong> ‚Üí Use Previous/Next/Shuffle to control playback</li>
    </ol>
    
    <h3>‚ö†Ô∏è Important Note About Spotify Audio:</h3>
    <p>Due to Spotify Web Playback SDK limitations, the visualizer uses your <strong>microphone</strong> to capture audio from your speakers. This means:</p>
    <ul>
        <li>‚úÖ You'll need to grant microphone permission when prompted</li>
        <li>‚úÖ Turn up your volume so the microphone can hear the music</li>
        <li>‚úÖ For best results, place microphone near speakers or use headphones with mic</li>
        <li>üí° <strong>Pro tip:</strong> Enable "Stereo Mix" or "System Audio Loopback" in your system settings for direct audio capture without microphone!</li>
    </ul>
    
    <h3>üéß How to Enable Stereo Mix (Windows):</h3>
    <ol>
        <li>Right-click speaker icon ‚Üí Sounds ‚Üí Recording tab</li>
        <li>Right-click empty space ‚Üí Show Disabled Devices</li>
        <li>Enable "Stereo Mix" and set as default recording device</li>
        <li>Refresh this page and grant microphone permission</li>
    </ol>
    
    <h3>üéß Mac Users:</h3>
    <p>Install a free audio routing tool like <strong>BlackHole</strong> or <strong>Loopback</strong> to route system audio to the browser.</p>

    
    <h3>üîÑ Fallback Modes:</h3>
    <p>If Spotify isn't available, the visualizer will automatically fall back to:</p>
    <ul>
        <li><strong>Microphone input</strong> (if <code>spotify = true</code> in code)</li>
        <li><strong>MP3 file</strong> (if <code>spotify = false</code> in code)</li>
    </ul>
</div>

<div class="controls">
<h1>What's Happening</h1>

<div>
    <h2>Collecting Input</h2>
    <p>This program plays an MP3 file from the HTML file, then uses the music data from that to make the textures</p>

    <p>This project uses Web Audio API to capture audio data from the audio that it hears. it splits is up by frequency
        into a 512 length array every frame (30 fps) that can be used by the program</p>
</div>

<div>
    <h2>Processing Audio Data</h2>
    <p>The frequency data is divided into three ranges:</p>
    <ul>
        <li>Bass (indices 0-100)</li>
        <li>Mid (100-200)</li>
        <li>High (200-300)</li>
    </ul>
    <p>Each range is averaged and normalized to 0 and 1 which can be used to change the textures<br>
        You can toggle each range with 1, 2, 3 (We only use indices 0-300, since the upper end is often unused).</p>
</div>

<div>
    <h2>Generating Procedural Textures</h2>
    <p>Three different textures are generated every frame, each responding to the audio.</p>

    <h3>Left Panel - Marble Texture</h3>
    <p>Uses a Perlin noise algorithm to morph the base sine pattern into an interesting marble design.
        Each band of frequencies affect it differently, bass creates large warps, mid creating smaller swirls,
        and high creates smaller fuzz.</p>

    <h3>Center Panel - Turbulence Visualization</h3>
    <p>Displays the turbulence function output for each range as color. Red for bass, green for mid, blue for high.
        Helps to show how each region of the texture is getting affected by the Perlin noise.</p>

    <h3>Right Panel - Frequency Graph</h3>
    <p>Displays audio data as a bar graph, helping to show how intense each range of frequencies is.</p>
</div>

<div>
    <h2>The Noise Algorithm</h2>

    <h3>Base Random Noise</h3>
    <p>We create a base grid of random static noise at the beginning that we'll use throughout. This static
        noise is important to help influence the texture into an interesting marble pattern.</p>

    <h3>Smooth Noise Function</h3>
    <p>Since we generate random static, we need to smooth it out so it doesn't look like static.
        We use bilinear interpolation to do this. We use fractional coordinates, then take the average color
        of the four nearest points weighted by how close the fractional coordinate it. This helps make smoother
        color transitions instead of harsh static.</p>

    <h3>Turbulence Function</h3>
    <p>The turbulence function is important for creating multiple levels of detail, this is also where we use the
        different bands of audio data. This function takes in an initial size, and samples the texture over a
        (256/size)x(256/size) range. So for example, if initial size was 64, then it would sample over a 4x4 version
        of the texture. So the bigger the initial size, the more large, widespread color patterns will affect it. While
        smaller sizes will let finer detail affect the texture. <br><br>It'll keep doing this with smaller and smaller sizes
        (starting at the initial size, dividing size by 2 at every loop) and stacking the values until it reaches a size of 1.
        <br><br>Each range uses a different initial size (bass 64, mid 16, high 4) which makes each range have differing effects.</p>

    <h3>Audio Integration</h3>
    <p>After calculating each turbulence at each initial size, we multiply each final result by its respective audio range.
        This is what allows the amount of bass, mid, and high frequencies to have weighted effects on the final output.</p>
</div>

<div>
    <h2>Color Controls</h2>
    <p>Using the controls above, you can change the color of the texture. You can also enable color mode, which will
        change the color of the texture based on how much bass, mid, and high there is.</p>
</div>
</div>

</body>
</html>